<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ·±ç©ºå›å“ - Echo Chamber</title>
    
    <!-- é¢„åŠ è½½å…³é”®èµ„æº -->
    <link rel="preload" href="css/main.css" as="style">
    <link rel="preload" href="js/core/DialogueSystem.js" as="script">
    <link rel="preload" href="js/core/GameManager.js" as="script">
    <link rel="preload" href="js/core/SimpleSenseSystem.js" as="script">
    <link rel="preload" href="js/story/StoryManager.js" as="script">
    <link rel="preload" href="Punch Deck - Ethereal.mp3" as="audio">
    <link rel="preload" href="medium-text-blip-14855.mp3" as="audio">
    
    <!-- å…³é”®CSSå†…è” -->
    <style>
        /* å…³é”®æ ·å¼ - å†…è”ä»¥æå‡é¦–å±æ¸²æŸ“é€Ÿåº¦ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            height: 100%; 
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f172a; 
            color: #ffffff; 
            overflow: hidden; 
        }
        .hidden { display: none !important; }
        #loading-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #0f172a; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; z-index: 1000; 
        }
        .loading-percentage { margin: 20px auto; text-align: center; }
        .loading-percentage span { 
            color: #6366f1; font-size: 2rem; font-weight: bold; 
            text-shadow: 0 0 10px rgba(99, 102, 241, 0.8); 
            animation: pulse 2s ease-in-out infinite; 
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
    
    <!-- æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/dialogue.css">
    <link rel="stylesheet" href="css/background.css">
    <link rel="stylesheet" href="css/continuous-sense.css">
    <link rel="stylesheet" href="css/bgm-controls.css">
    <link rel="stylesheet" href="css/term.css">
    
    <!-- å­—ä½“ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- èƒŒæ™¯éŸ³ä¹ -->
    <audio id="bgm-audio" loop>
        <source src="Punch Deck - Ethereal.mp3" type="audio/mpeg">
    </audio>
    
</head>
<body>
    <!-- èƒŒæ™¯ç³»ç»Ÿ -->
    <div id="background-container">
        <div id="background-overlay"></div>
        <div id="glitch-effect"></div>
    </div>

    <!-- ä¸»æ¸¸æˆç•Œé¢ -->
    <div id="game-container">

        <!-- å¯¹è¯ç³»ç»Ÿ -->
        <div id="dialogue-container" class="hidden">
            <!-- è¯´è¯è€…åç§° -->
            <div id="speaker-name" class="speaker-name"></div>
            
            <!-- å¯¹è¯æ–‡æœ¬ -->
            <div id="dialogue-text" class="dialogue-text"></div>
            
            <!-- ç©å®¶å›å¤ï¼ˆå­—å¹•æ ·å¼ï¼‰ -->
            <div id="player-response" class="player-response hidden"></div>
        </div>

        <!-- é€‰æ‹©ç³»ç»Ÿ -->
        <div id="choices-container" class="choices-container hidden">
            <div id="choices-panel" class="choices-panel"></div>
        </div>

        <!-- BGMæ§åˆ¶æŒ‰é’® -->
        <div id="bgm-controls" class="bgm-controls">
            <button id="bgm-toggle" class="bgm-toggle" title="èƒŒæ™¯éŸ³ä¹å¼€å…³">ğŸµ</button>
            <div id="bgm-volume-control" class="bgm-volume-control hidden">
                <input type="range" id="bgm-volume-slider" min="0" max="100" value="30" title="éŸ³é‡æ§åˆ¶">
                <span id="bgm-volume-text">30%</span>
            </div>
        </div>

        <!-- è®¾ç½®é¢æ¿ -->
        <div id="settings-panel" class="settings-panel hidden">
            <div class="settings-content">
                <h3>è®¾ç½®</h3>
                
                <div class="setting-group">
                    <label>æ–‡æœ¬é€Ÿåº¦</label>
                    <input type="range" id="text-speed" min="0.01" max="0.2" step="0.01" value="0.05">
                    <span id="speed-value">0.05</span>
                </div>
                
                <div class="setting-group">
                    <label>éŸ³ä¹éŸ³é‡</label>
                    <input type="range" id="music-volume" min="0" max="1" step="0.1" value="0.7">
                    <span id="music-value">0.7</span>
                </div>
                
                <div class="setting-group">
                    <label>éŸ³æ•ˆéŸ³é‡</label>
                    <input type="range" id="sfx-volume" min="0" max="1" step="0.1" value="0.8">
                    <span id="sfx-value">0.8</span>
                </div>
                
                <div class="setting-buttons">
                    <button id="save-settings">ä¿å­˜</button>
                    <button id="close-settings">å…³é—­</button>
                </div>
            </div>
        </div>

        <!-- åŠ è½½æç¤º -->
        <div id="loading-screen" class="loading-screen">
            <div class="loading-content">
                <h2>æ·±ç©ºå›å“</h2>
                <p id="loading-text">æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿ...</p>
                <div class="loading-percentage">
                    <span id="loading-percentage">0%</span>
                </div>
            </div>
        </div>

        <!-- è¯­è¨€é€‰æ‹©ç•Œé¢ -->
        <div id="language-selection-screen" class="language-selection-screen hidden">
            <div class="language-selection-content">
                <h2 class="language-title">é€‰æ‹©è¯­è¨€ / Select Language</h2>
                <div class="language-buttons">
                    <button class="language-button" data-lang="zh">
                        <span class="language-flag">ğŸ‡¨ğŸ‡³</span>
                        <span class="language-name">ä¸­æ–‡</span>
                        <span class="language-subtitle">ç®€ä½“ä¸­æ–‡</span>
                    </button>
                    <button class="language-button" data-lang="en">
                        <span class="language-flag">ğŸ‡ºğŸ‡¸</span>
                        <span class="language-name">English</span>
                        <span class="language-subtitle">English</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- éŸ³é¢‘å…ƒç´  -->
    <audio id="background-music" loop></audio>
    <audio id="typewriter-sound" src="medium-text-blip-14855.mp3" preload="auto"></audio>
    <audio id="glitch-sound"></audio>
    <audio id="dialogue-advance-sound"></audio>
    <audio id="cycle-complete-sound"></audio>

    <!-- ä¼˜åŒ–å·¥å…·è„šæœ¬ - ä¼˜å…ˆåŠ è½½ -->
    <script src="js/utils/Logger.js"></script>
    <script src="js/utils/DOMOptimizer.js"></script>
    <script src="js/utils/MemoryManager.js"></script>
    <script src="js/utils/PerformanceMonitor.js"></script>
    
    <!-- æ ¸å¿ƒæ¸¸æˆè„šæœ¬ - åŒæ­¥åŠ è½½ -->
    <script src="js/utils/ColorUtils.js"></script>
    <script src="js/core/GameManager.js"></script>
    <script src="js/core/TermSystem.js"></script>
    <script src="js/core/DialogueSystem.js"></script>
    <script src="js/core/BackgroundSystem.js"></script>
    
    <!-- éå…³é”®è„šæœ¬ - å¼‚æ­¥åŠ è½½ -->
    <script async src="js/core/SimpleSenseSystem.js"></script>
    <script async src="js/core/BGMManager.js"></script>
    <script async src="js/story/EnhancedDeepSkyScript.js"></script>
    <script async src="js/story/EnhancedDeepSkyScript_EN.js"></script>
    <script async src="js/story/StoryManager.js"></script>
    
    <!-- ä¸»å¯åŠ¨è„šæœ¬ -->
    <script>
        // åˆå§‹åŒ–ä¼˜åŒ–ç³»ç»Ÿ
        function initializeOptimizations() {
            Logger.info('ğŸš€ åˆå§‹åŒ–æ€§èƒ½ä¼˜åŒ–ç³»ç»Ÿ...');
            
            // åˆå§‹åŒ– DOM ä¼˜åŒ–å™¨
            if (window.DOMOptimizer) {
                DOMOptimizer.initialize();
            }
            
            // åˆå§‹åŒ–æ€§èƒ½ç›‘æ§ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                if (window.PerformanceMonitor) {
                    PerformanceMonitor.initialize();
                    PerformanceMonitor.show();
                }
            } else {
                // ç”Ÿäº§ç¯å¢ƒç¦ç”¨è°ƒè¯•æ—¥å¿—
                Logger.setDebugMode(false);
                Logger.info('ç”Ÿäº§ç¯å¢ƒï¼šè°ƒè¯•æ—¥å¿—å·²ç¦ç”¨');
            }
            
            Logger.success('æ€§èƒ½ä¼˜åŒ–ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
            
            // æ·»åŠ é”®ç›˜å¿«æ·é”®
            this.setupKeyboardShortcuts();
        }
        
        // è®¾ç½®é”®ç›˜å¿«æ·é”®
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl + Shift + P: åˆ‡æ¢æ€§èƒ½ç›‘æ§
                if (e.ctrlKey && e.shiftKey && e.key === 'P') {
                    e.preventDefault();
                    if (window.PerformanceMonitor) {
                        PerformanceMonitor.toggle();
                    }
                }
                
                // Ctrl + Shift + L: åˆ‡æ¢æ—¥å¿—çº§åˆ«
                if (e.ctrlKey && e.shiftKey && e.key === 'L') {
                    e.preventDefault();
                    if (window.Logger) {
                        const currentMode = Logger.isDebug;
                        Logger.setDebugMode(!currentMode);
                        Logger.info(`è°ƒè¯•æ¨¡å¼: ${!currentMode ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
                    }
                }
                
                // Ctrl + Shift + M: æ˜¾ç¤ºå†…å­˜ç»Ÿè®¡
                if (e.ctrlKey && e.shiftKey && e.key === 'M') {
                    e.preventDefault();
                    if (window.MemoryManager) {
                        const stats = MemoryManager.getStats();
                        console.table(stats);
                        Logger.info('å†…å­˜ç»Ÿè®¡å·²è¾“å‡ºåˆ°æ§åˆ¶å°');
                    }
                }
                
                // Ctrl + Shift + C: æ¸…ç†å†…å­˜
                if (e.ctrlKey && e.shiftKey && e.key === 'C') {
                    e.preventDefault();
                    if (window.MemoryManager) {
                        MemoryManager.cleanup();
                        Logger.success('å†…å­˜æ¸…ç†å®Œæˆ');
                    }
                }
            });
            
            Logger.info('é”®ç›˜å¿«æ·é”®å·²è®¾ç½®: Ctrl+Shift+P(æ€§èƒ½ç›‘æ§), Ctrl+Shift+L(æ—¥å¿—), Ctrl+Shift+M(å†…å­˜ç»Ÿè®¡), Ctrl+Shift+C(æ¸…ç†å†…å­˜)');
        }
        
        // æ·¡å…¥äº”æ„Ÿç³»ç»Ÿ
        function fadeInSenses() {
            Logger.info('ğŸ‘ï¸ å¼€å§‹æ·¡å…¥äº”æ„Ÿç³»ç»Ÿ...');
            
            // è·å–äº”æ„Ÿå®¹å™¨
            const sensesContainer = document.getElementById('persistent-senses-container');
            if (sensesContainer) {
                // åˆå§‹çŠ¶æ€ï¼šé€æ˜
                sensesContainer.style.opacity = '0';
                sensesContainer.style.transform = 'translateX(-50%) translateY(-20px)';
                sensesContainer.style.transition = 'all 1.2s cubic-bezier(0.4, 0, 0.2, 1)';
                
                // å»¶è¿Ÿæ·¡å…¥
                setTimeout(() => {
                    sensesContainer.style.opacity = '1';
                    sensesContainer.style.transform = 'translateX(-50%) translateY(0)';
                    console.log('âœ… äº”æ„Ÿç³»ç»Ÿæ·¡å…¥å®Œæˆ');
                }, 200);
            }
        }

        // èƒŒæ™¯é¢œè‰²è¿‡æ¸¡
        function startBackgroundTransition() {
            console.log('ğŸ¨ å¼€å§‹èƒŒæ™¯é¢œè‰²è¿‡æ¸¡...');
            const body = document.body;
            const gameContainer = document.getElementById('game-container');
            
            if (body && gameContainer) {
                // è®¾ç½®åˆå§‹èƒŒæ™¯è‰²ï¼ˆæ·±è‰²ï¼‰
                body.style.background = '#1a1a1a';
                gameContainer.style.background = 'linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%)';
                
                // æ·»åŠ è¿‡æ¸¡æ•ˆæœ
                body.style.transition = 'background 2s ease-in-out';
                gameContainer.style.transition = 'background 2s ease-in-out';
                
                // å»¶è¿Ÿè¿‡æ¸¡åˆ°æ¸¸æˆèƒŒæ™¯è‰²
                setTimeout(() => {
                    body.style.background = '#0f0f0f';
                    gameContainer.style.background = 'linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 50%, #2d2d2d 100%)';
                    console.log('âœ… èƒŒæ™¯é¢œè‰²è¿‡æ¸¡å®Œæˆ');
                }, 500);
            }
        }

        // æ¸¸æˆå¯åŠ¨
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸš€ æ·±ç©ºå›å“ - æ­£åœ¨å¯åŠ¨...');
            
            // è·å–åŠ è½½ç›¸å…³å…ƒç´ 
            const loadingText = document.getElementById('loading-text');
            
            console.log('ğŸ” è°ƒè¯•ä¿¡æ¯:');
            console.log('loadingText:', loadingText);
            
            // æ›´æ–°åŠ è½½è¿›åº¦
            function updateProgress(step, total, message) {
                const percentage = (step / total) * 100;
                console.log(`ğŸ“Š æ›´æ–°è¿›åº¦: ${step}/${total} (${Math.round(percentage)}%) - ${message}`);
                
                // æ›´æ–°ç™¾åˆ†æ¯”æ–‡æœ¬
                const percentageElement = document.getElementById('loading-percentage');
                if (percentageElement) {
                    percentageElement.textContent = Math.round(percentage) + '%'; 
                    console.log('âœ… ç™¾åˆ†æ¯”æ–‡æœ¬å·²æ›´æ–°:', Math.round(percentage) + '%');
                } else {
                    console.error('âŒ loading-percentageå…ƒç´ æœªæ‰¾åˆ°');
                }
                
                if (loadingText) {
                    loadingText.textContent = message;
                    console.log('âœ… æ–‡æœ¬å·²æ›´æ–°:', message);
                } else {
                    console.error('âŒ loadingTextå…ƒç´ æœªæ‰¾åˆ°');
                }
            }
            
            // ç«‹å³æµ‹è¯•è¿›åº¦æ›´æ–°
            updateProgress(0, 11, 'å¼€å§‹åˆå§‹åŒ–...');
            
            try {
                // ç®€åŒ–åˆå§‹åŒ–è¿‡ç¨‹
                updateProgress(1, 11, 'æ­£åœ¨åŠ è½½æ¨¡å—...');
                await new Promise(resolve => setTimeout(resolve, 200));
                
                updateProgress(2, 11, 'æ­£åœ¨åˆå§‹åŒ–æ¸¸æˆç®¡ç†å™¨...');
                console.log('ğŸ“‹ æ­£åœ¨åˆå§‹åŒ– GameManager...');
                try {
                    if (typeof GameManager !== 'undefined') {
                        await GameManager.initialize();
                        console.log('âœ… GameManager åˆå§‹åŒ–å®Œæˆ');
                    } else {
                        console.error('âŒ GameManager æœªå®šä¹‰');
                    }
                } catch (error) {
                    console.error('âŒ GameManager åˆå§‹åŒ–å¤±è´¥:', error);
                }
                
                // åˆå§‹åŒ–æœ¯è¯­ç³»ç»Ÿ
                console.log('ğŸ“š æ­£åœ¨åˆå§‹åŒ– TermSystem...');
                try {
                    if (typeof TermSystem !== 'undefined') {
                        TermSystem.initialize();
                        // åˆå§‹åŒ–å‰§æœ¬æœ¯è¯­
                        if (typeof EnhancedDeepSkyScript !== 'undefined' && EnhancedDeepSkyScript.initializeTerms) {
                            EnhancedDeepSkyScript.initializeTerms();
                        }
                        console.log('âœ… TermSystem åˆå§‹åŒ–å®Œæˆ');
                    } else {
                        console.error('âŒ TermSystem æœªå®šä¹‰');
                    }
                } catch (error) {
                    console.error('âŒ TermSystem åˆå§‹åŒ–å¤±è´¥:', error);
                }
                await new Promise(resolve => setTimeout(resolve, 200));
                
                updateProgress(3, 11, 'æ­£åœ¨åˆå§‹åŒ–å¯¹è¯ç³»ç»Ÿ...');
                console.log('ğŸ’¬ æ­£åœ¨åˆå§‹åŒ– DialogueSystem...');
                try {
                    if (typeof DialogueSystem !== 'undefined') {
                        await DialogueSystem.initialize();
                        console.log('âœ… DialogueSystem åˆå§‹åŒ–å®Œæˆ');
                    } else {
                        console.error('âŒ DialogueSystem æœªå®šä¹‰');
                    }
                } catch (error) {
                    console.error('âŒ DialogueSystem åˆå§‹åŒ–å¤±è´¥:', error);
                }
                await new Promise(resolve => setTimeout(resolve, 200));
                
                updateProgress(4, 11, 'æ­£åœ¨åˆå§‹åŒ–èƒŒæ™¯ç³»ç»Ÿ...');
                console.log('ğŸ¨ æ­£åœ¨åˆå§‹åŒ– BackgroundSystem...');
                try {
                    if (typeof BackgroundSystem !== 'undefined') {
                        await BackgroundSystem.initialize();
                        console.log('âœ… BackgroundSystem åˆå§‹åŒ–å®Œæˆ');
                    } else {
                        console.error('âŒ BackgroundSystem æœªå®šä¹‰');
                    }
                } catch (error) {
                    console.error('âŒ BackgroundSystem åˆå§‹åŒ–å¤±è´¥:', error);
                }
                await new Promise(resolve => setTimeout(resolve, 200));
                
                updateProgress(5, 11, 'æ­£åœ¨åˆå§‹åŒ–äº”æ„Ÿç³»ç»Ÿ...');
                console.log('ğŸ‘ï¸ æ­£åœ¨åˆå§‹åŒ– SimpleSenseSystem...');
                try {
                    if (typeof SimpleSenseSystem !== 'undefined') {
                        SimpleSenseSystem.initialize();
                        console.log('âœ… SimpleSenseSystem åˆå§‹åŒ–å®Œæˆ');
                    } else {
                        console.error('âŒ SimpleSenseSystem æœªå®šä¹‰');
                    }
                } catch (error) {
                    console.error('âŒ SimpleSenseSystem åˆå§‹åŒ–å¤±è´¥:', error);
                }
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // TextEffectManager å·²åˆ é™¤
                await new Promise(resolve => setTimeout(resolve, 200));
                
                await new Promise(resolve => setTimeout(resolve, 200));
                
                updateProgress(8, 11, 'æ­£åœ¨å¯åŠ¨æ¸¸æˆ...');
                console.log('ğŸ® æ­£åœ¨å¯åŠ¨æ¸¸æˆ...');
                
                // å»¶è¿Ÿåˆå§‹åŒ–éå…³é”®ç³»ç»Ÿï¼ˆå·²ç§»é™¤ï¼‰
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // RuntimeDialogues å·²åˆ é™¤ï¼Œç›´æ¥ä½¿ç”¨ EnhancedDeepSkyScript
                
                updateProgress(10, 11, 'æ­£åœ¨åˆå§‹åŒ–å‰§æƒ…ç³»ç»Ÿ...');
                console.log('ğŸ“– æ­£åœ¨åˆå§‹åŒ– StoryManager...');
                try {
                    if (typeof StoryManager !== 'undefined') {
                        await StoryManager.initialize();
                        console.log('âœ… StoryManager åˆå§‹åŒ–å®Œæˆ');
                    } else {
                        console.error('âŒ StoryManager æœªå®šä¹‰');
                    }
                } catch (error) {
                    console.error('âŒ StoryManager åˆå§‹åŒ–å¤±è´¥:', error);
                }
                
                updateProgress(11, 11, 'æ­£åœ¨åˆå§‹åŒ–èƒŒæ™¯éŸ³ä¹...');
                console.log('ğŸµ æ­£åœ¨åˆå§‹åŒ– BGMManager...');
                try {
                    if (typeof BGMManager !== 'undefined') {
                        BGMManager.initialize();
                        console.log('âœ… BGMManager åˆå§‹åŒ–å®Œæˆ');
                    } else {
                        console.error('âŒ BGMManager æœªå®šä¹‰');
                    }
                } catch (error) {
                    console.error('âŒ BGMManager åˆå§‹åŒ–å¤±è´¥:', error);
                }
                
                // åˆå§‹åŒ–äº”æ„Ÿæ˜¾ç¤º
                updateProgress(9, 9, 'æ­£åœ¨åˆå§‹åŒ–äº”æ„Ÿç³»ç»Ÿ...');
                console.log('ğŸ‘ï¸ æ­£åœ¨åˆå§‹åŒ–äº”æ„Ÿæ˜¾ç¤º...');
                try {
                    // åˆå§‹åŒ–æŒç»­æ˜¾ç¤ºäº”æ„Ÿç³»ç»Ÿ
                    if (typeof SimpleSenseSystem !== 'undefined') {
                        SimpleSenseSystem.initialize();
                        console.log('âœ… æŒç»­æ˜¾ç¤ºäº”æ„Ÿç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
                    }
                } catch (error) {
                    console.error('âŒ äº”æ„Ÿç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);
                }
                
                // å®Œæˆåˆå§‹åŒ–
                updateProgress(11, 11, 'åˆå§‹åŒ–å®Œæˆï¼Œæ­£åœ¨å¯åŠ¨æ¸¸æˆ...');
                
                // çŸ­æš‚å»¶è¿Ÿåéšè—åŠ è½½å±å¹•ï¼Œæ˜¾ç¤ºè¯­è¨€é€‰æ‹©
                setTimeout(() => {
                    const loadingScreen = document.getElementById('loading-screen');
                    if (loadingScreen) {
                        loadingScreen.classList.add('hidden');
                        console.log('ğŸ® åŠ è½½å±å¹•å·²éšè—');
                    }
                    
                    // æ˜¾ç¤ºè¯­è¨€é€‰æ‹©ç•Œé¢
                    showLanguageSelection();
                }, 500);
                
            } catch (error) {
                console.error('âŒ æ¸¸æˆå¯åŠ¨å¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.stack);
                
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.innerHTML = 
                        '<div class="error-content"><h2>å¯åŠ¨å¤±è´¥</h2><p>é”™è¯¯: ' + error.message + '</p><p>è¯·åˆ·æ–°é¡µé¢é‡è¯•</p></div>';
                }
            }
        });
        
        // æ˜¾ç¤ºè¯­è¨€é€‰æ‹©ç•Œé¢
        function showLanguageSelection() {
            const languageScreen = document.getElementById('language-selection-screen');
            if (!languageScreen) return;
            
            languageScreen.classList.remove('hidden');
            
            // ä¸ºæŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
            const languageButtons = languageScreen.querySelectorAll('.language-button');
            languageButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const selectedLang = button.getAttribute('data-lang');
                    console.log(`ğŸŒ é€‰æ‹©è¯­è¨€: ${selectedLang}`);
                    
                    // ä¿å­˜è¯­è¨€é€‰æ‹©
                    localStorage.setItem('gameLanguage', selectedLang);
                    
                    // è®¾ç½®è¯­è¨€
                    if (selectedLang === 'en') {
                        console.log('ğŸŒ å¼€å§‹åˆ‡æ¢åˆ°è‹±æ–‡...');
                        console.log('EnhancedDeepSkyScript_EN æ˜¯å¦å­˜åœ¨:', typeof EnhancedDeepSkyScript_EN !== 'undefined');
                        
                        if (typeof EnhancedDeepSkyScript_EN !== 'undefined') {
                            // ç›´æ¥æ›¿æ¢å…¨å±€è„šæœ¬
                            window.EnhancedDeepSkyScript = window.EnhancedDeepSkyScript_EN;
                            console.log('ğŸŒ å·²æ›¿æ¢ window.EnhancedDeepSkyScript');
                            console.log('æµ‹è¯•è°ƒç”¨:', window.EnhancedDeepSkyScript.getCycle1().title);
                            
                            // é‡æ–°åˆå§‹åŒ– StoryManager æ•°æ®
                            if (window.StoryManager) {
                                console.log('ğŸŒ é‡æ–°åˆå§‹åŒ– StoryManager...');
                                StoryManager.storyData.cycles = [];
                                StoryManager.initializeStoryData();
                                console.log('ğŸŒ StoryManager cycles æ•°é‡:', StoryManager.storyData.cycles.length);
                                console.log('ğŸŒ ç¬¬ä¸€ä¸ª cycle æ ‡é¢˜:', StoryManager.storyData.cycles[0]?.title);
                            }
                            
                            // åˆå§‹åŒ–è‹±æ–‡æœ¯è¯­
                            if (window.TermSystem) {
                                TermSystem.terms.clear();
                                if (window.EnhancedDeepSkyScript.initializeTerms) {
                                    window.EnhancedDeepSkyScript.initializeTerms();
                                }
                                console.log('ğŸŒ å·²åŠ è½½è‹±æ–‡æœ¯è¯­ï¼Œæœ¯è¯­æ•°é‡:', TermSystem.terms.size);
                            }
                            
                            // åˆ·æ–°äº”æ„Ÿåç§°
                            if (window.SimpleSenseSystem) {
                                SimpleSenseSystem.refreshAllSenseNames();
                            }
                        } else {
                            console.error('âŒ EnhancedDeepSkyScript_EN æœªå®šä¹‰ï¼');
                        }
                    } else {
                        console.log('ğŸŒ ä½¿ç”¨ä¸­æ–‡è„šæœ¬');
                        // ä¸­æ–‡ä¹Ÿéœ€è¦åˆå§‹åŒ–æ•°æ®
                        if (window.StoryManager) {
                            StoryManager.storyData.cycles = [];
                            StoryManager.initializeStoryData();
                            console.log('ğŸŒ å·²åŠ è½½ä¸­æ–‡æ•°æ®');
                        }
                        
                        // åˆ·æ–°äº”æ„Ÿåç§°
                        if (window.SimpleSenseSystem) {
                            SimpleSenseSystem.refreshAllSenseNames();
                        }
                    }
                    
                    // éšè—è¯­è¨€é€‰æ‹©ç•Œé¢
                    languageScreen.classList.add('hidden');
                    
                    // å¼€å§‹æ¸¸æˆ
                    startGame();
                });
            });
        }
        
        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            Logger.success('âœ… æ‰€æœ‰ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œå‡†å¤‡å¯åŠ¨æ¸¸æˆ');
            
            // åˆå§‹åŒ–ä¼˜åŒ–ç³»ç»Ÿ
            initializeOptimizations();
            
            // å¼€å§‹èƒŒæ™¯é¢œè‰²è¿‡æ¸¡
            startBackgroundTransition();
            
            // å¯åŠ¨èƒŒæ™¯éŸ³ä¹
            if (typeof BGMManager !== 'undefined') {
                BGMManager.startBGM();
                console.log('ğŸµ èƒŒæ™¯éŸ³ä¹å·²å¯åŠ¨');
                
                // åˆå§‹åŒ–BGMæ§åˆ¶
                initializeBGMControls();
            }
            
            // å»¶è¿Ÿå¯åŠ¨æ¸¸æˆ
            setTimeout(() => {
                if (typeof StoryManager !== 'undefined') {
                    // å…ˆæ·¡å…¥äº”æ„Ÿç³»ç»Ÿ
                    fadeInSenses();
                    
                    // å»¶è¿Ÿå¯åŠ¨å¯¹è¯
                    setTimeout(() => {
                        StoryManager.startGame();
                        console.log('ğŸ¯ æ¸¸æˆå·²å¼€å§‹');
                    }, 1000);
                } else {
                    console.error('âŒ StoryManager æœªæ‰¾åˆ°');
                }
            }, 800);
        }
        
        // åˆå§‹åŒ–BGMæ§åˆ¶
        function initializeBGMControls() {
            const bgmToggle = document.getElementById('bgm-toggle');
            const bgmVolumeControl = document.getElementById('bgm-volume-control');
            const bgmVolumeSlider = document.getElementById('bgm-volume-slider');
            const bgmVolumeText = document.getElementById('bgm-volume-text');
            
            if (!bgmToggle || !bgmVolumeControl || !bgmVolumeSlider || !bgmVolumeText) {
                console.warn('BGMæ§åˆ¶å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            // åˆ‡æ¢BGMæ’­æ”¾/æš‚åœ
            bgmToggle.addEventListener('click', () => {
                if (BGMManager.isPlaying) {
                    BGMManager.pauseBGM();
                    bgmToggle.classList.add('muted');
                    bgmToggle.textContent = 'ğŸ”‡';
                } else {
                    BGMManager.resumeBGM();
                    bgmToggle.classList.remove('muted');
                    bgmToggle.textContent = 'ğŸµ';
                }
            });
            
            // éŸ³é‡æ§åˆ¶
            bgmVolumeSlider.addEventListener('input', (e) => {
                const volume = parseInt(e.target.value) / 100;
                BGMManager.setVolume(volume);
                bgmVolumeText.textContent = e.target.value + '%';
            });
            
            // æ˜¾ç¤º/éšè—éŸ³é‡æ§åˆ¶
            bgmToggle.addEventListener('mouseenter', () => {
                bgmVolumeControl.classList.remove('hidden');
            });
            
            bgmVolumeControl.addEventListener('mouseleave', () => {
                bgmVolumeControl.classList.add('hidden');
            });
            
            // åˆå§‹åŒ–çŠ¶æ€ - é»˜è®¤æ˜¾ç¤ºéŸ³ä¹å¼€å¯çŠ¶æ€
            bgmToggle.classList.remove('muted');
            bgmToggle.textContent = 'ğŸµ';
            
            // è®¾ç½®çŠ¶æ€å˜åŒ–å›è°ƒ
            BGMManager.onStateChange = (isPlaying) => {
                if (isPlaying) {
                    bgmToggle.classList.remove('muted');
                    bgmToggle.textContent = 'ğŸµ';
                    console.log('ğŸµ BGMæ§åˆ¶ï¼šéŸ³ä¹å¼€å§‹æ’­æ”¾ï¼Œæ˜¾ç¤ºå¼€å¯çŠ¶æ€');
                } else {
                    bgmToggle.classList.add('muted');
                    bgmToggle.textContent = 'ğŸ”‡';
                    console.log('ğŸµ BGMæ§åˆ¶ï¼šéŸ³ä¹åœæ­¢æ’­æ”¾ï¼Œæ˜¾ç¤ºå…³é—­çŠ¶æ€');
                }
            };
            
            // ç«‹å³æ£€æŸ¥å½“å‰çŠ¶æ€
            if (!BGMManager.isPlaying) {
                bgmToggle.classList.add('muted');
                bgmToggle.textContent = 'ğŸ”‡';
            }
            
            console.log('ğŸµ BGMæ§åˆ¶åˆå§‹åŒ–å®Œæˆ');
        }
    </script>
</body>
</html>