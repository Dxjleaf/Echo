<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ·±ç©ºå›å“ - Echo Chamber</title>
    
    <!-- é¢„åŠ è½½å…³é”®èµ„æº -->
    <link rel="preload" href="css/main.css" as="style">
    <link rel="preload" href="js/core/DialogueSystem.js" as="script">
    <link rel="preload" href="js/core/GameManager.js" as="script">
    
    <!-- å…³é”®CSSå†…è” -->
    <style>
        /* å…³é”®æ ·å¼ - å†…è”ä»¥æå‡é¦–å±æ¸²æŸ“é€Ÿåº¦ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            height: 100%; 
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f172a; 
            color: #ffffff; 
            overflow: hidden; 
        }
        .hidden { display: none !important; }
        #loading-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #0f172a; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; z-index: 1000; 
        }
        .loading-percentage { margin: 20px auto; text-align: center; }
        .loading-percentage span { 
            color: #6366f1; font-size: 2rem; font-weight: bold; 
            text-shadow: 0 0 10px rgba(99, 102, 241, 0.8); 
            animation: pulse 2s ease-in-out infinite; 
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
    
    <!-- æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/dialogue.css">
    <link rel="stylesheet" href="css/background.css">
    <link rel="stylesheet" href="css/continuous-sense.css">
    <link rel="stylesheet" href="css/bgm-controls.css">
    
    <!-- å­—ä½“ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- èƒŒæ™¯éŸ³ä¹ -->
    <audio id="bgm-audio" loop>
        <source src="Punch Deck - Ethereal.mp3" type="audio/mpeg">
    </audio>
    
</head>
<body>
    <!-- èƒŒæ™¯ç³»ç»Ÿ -->
    <div id="background-container">
        <div id="background-overlay"></div>
        <div id="glitch-effect"></div>
    </div>

    <!-- ä¸»æ¸¸æˆç•Œé¢ -->
    <div id="game-container">

        <!-- å¯¹è¯ç³»ç»Ÿ -->
        <div id="dialogue-container" class="hidden">
            <!-- è¯´è¯è€…åç§° -->
            <div id="speaker-name" class="speaker-name"></div>
            
            <!-- å¯¹è¯æ–‡æœ¬ -->
            <div id="dialogue-text" class="dialogue-text"></div>
            
            <!-- ç©å®¶å›å¤ï¼ˆå­—å¹•æ ·å¼ï¼‰ -->
            <div id="player-response" class="player-response hidden"></div>
        </div>

        <!-- é€‰æ‹©ç³»ç»Ÿ -->
        <div id="choices-container" class="choices-container hidden">
            <div id="choices-panel" class="choices-panel"></div>
        </div>

        <!-- BGMæ§åˆ¶æŒ‰é’® -->
        <div id="bgm-controls" class="bgm-controls">
            <button id="bgm-toggle" class="bgm-toggle" title="èƒŒæ™¯éŸ³ä¹å¼€å…³">ğŸµ</button>
            <div id="bgm-volume-control" class="bgm-volume-control hidden">
                <input type="range" id="bgm-volume-slider" min="0" max="100" value="30" title="éŸ³é‡æ§åˆ¶">
                <span id="bgm-volume-text">30%</span>
            </div>
        </div>

        <!-- è¯­è¨€åˆ‡æ¢æŒ‰é’® -->
        <div id="language-controls" class="language-controls">
            <button id="language-toggle" class="language-toggle" title="è¯­è¨€åˆ‡æ¢">ğŸŒ</button>
        </div>

        <!-- è®¾ç½®é¢æ¿ -->
        <div id="settings-panel" class="settings-panel hidden">
            <div class="settings-content">
                <h3>è®¾ç½®</h3>
                
                <div class="setting-group">
                    <label>æ–‡æœ¬é€Ÿåº¦</label>
                    <input type="range" id="text-speed" min="0.01" max="0.2" step="0.01" value="0.05">
                    <span id="speed-value">0.05</span>
                </div>
                
                <div class="setting-group">
                    <label>éŸ³ä¹éŸ³é‡</label>
                    <input type="range" id="music-volume" min="0" max="1" step="0.1" value="0.7">
                    <span id="music-value">0.7</span>
                </div>
                
                <div class="setting-group">
                    <label>éŸ³æ•ˆéŸ³é‡</label>
                    <input type="range" id="sfx-volume" min="0" max="1" step="0.1" value="0.8">
                    <span id="sfx-value">0.8</span>
                </div>
                
                <div class="setting-buttons">
                    <button id="save-settings">ä¿å­˜</button>
                    <button id="close-settings">å…³é—­</button>
                </div>
            </div>
        </div>

        <!-- åŠ è½½æç¤º -->
        <div id="loading-screen" class="loading-screen">
            <div class="loading-content">
                <h2>æ·±ç©ºå›å“</h2>
                <p id="loading-text">æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿ...</p>
                <div class="loading-percentage">
                    <span id="loading-percentage">0%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- éŸ³é¢‘å…ƒç´  -->
    <audio id="background-music" loop></audio>
    <audio id="typewriter-sound" src="medium-text-blip-14855.mp3" preload="auto"></audio>
    <audio id="glitch-sound"></audio>
    <audio id="dialogue-advance-sound"></audio>
    <audio id="cycle-complete-sound"></audio>

    <!-- æ ¸å¿ƒæ¸¸æˆè„šæœ¬ - åŒæ­¥åŠ è½½ -->
    <script src="js/utils/ColorUtils.js"></script>
    <script src="js/core/GameManager.js"></script>
    <script src="js/core/DialogueSystem.js"></script>
    <script src="js/core/BackgroundSystem.js"></script>
    <script src="js/core/SimpleSenseSystem.js"></script>
    <script src="js/core/BGMManager.js"></script>
    <script src="js/story/EnhancedDeepSkyScript.js"></script>
    <script src="js/story/EnhancedDeepSkyScript_EN.js"></script>
    <script src="js/story/StoryManager.js"></script>
    
    <!-- éå…³é”®è„šæœ¬ - å¼‚æ­¥åŠ è½½ -->
    <script async src="js/utils/SmartColorAdapter.js"></script>
    <script async src="js/utils/ResourceOptimizer.js"></script>
    
    <!-- ä¸»å¯åŠ¨è„šæœ¬ -->
    <script>
        // æ·¡å…¥äº”æ„Ÿç³»ç»Ÿ
        function fadeInSenses() {
            console.log('ğŸ‘ï¸ å¼€å§‹æ·¡å…¥äº”æ„Ÿç³»ç»Ÿ...');
            
            // è·å–äº”æ„Ÿå®¹å™¨
            const sensesContainer = document.getElementById('persistent-senses-container');
            if (sensesContainer) {
                // åˆå§‹çŠ¶æ€ï¼šé€æ˜
                sensesContainer.style.opacity = '0';
                sensesContainer.style.transform = 'translateX(-50%) translateY(-20px)';
                sensesContainer.style.transition = 'all 1.2s cubic-bezier(0.4, 0, 0.2, 1)';
                
                // å»¶è¿Ÿæ·¡å…¥
                setTimeout(() => {
                    sensesContainer.style.opacity = '1';
                    sensesContainer.style.transform = 'translateX(-50%) translateY(0)';
                    console.log('âœ… äº”æ„Ÿç³»ç»Ÿæ·¡å…¥å®Œæˆ');
                }, 200);
            }
        }

        // èƒŒæ™¯é¢œè‰²è¿‡æ¸¡
        function startBackgroundTransition() {
            console.log('ğŸ¨ å¼€å§‹èƒŒæ™¯é¢œè‰²è¿‡æ¸¡...');
            const body = document.body;
            const gameContainer = document.getElementById('game-container');
            
            if (body && gameContainer) {
                // è®¾ç½®åˆå§‹èƒŒæ™¯è‰²ï¼ˆæ·±è‰²ï¼‰
                body.style.background = '#1a1a1a';
                gameContainer.style.background = 'linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%)';
                
                // æ·»åŠ è¿‡æ¸¡æ•ˆæœ
                body.style.transition = 'background 2s ease-in-out';
                gameContainer.style.transition = 'background 2s ease-in-out';
                
                // å»¶è¿Ÿè¿‡æ¸¡åˆ°æ¸¸æˆèƒŒæ™¯è‰²
                setTimeout(() => {
                    body.style.background = '#0f0f0f';
                    gameContainer.style.background = 'linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 50%, #2d2d2d 100%)';
                    console.log('âœ… èƒŒæ™¯é¢œè‰²è¿‡æ¸¡å®Œæˆ');
                }, 500);
            }
        }

        // æ¸¸æˆå¯åŠ¨
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸš€ æ·±ç©ºå›å“ - æ­£åœ¨å¯åŠ¨...');
            
            // è·å–åŠ è½½ç›¸å…³å…ƒç´ 
            const loadingText = document.getElementById('loading-text');
            
            console.log('ğŸ” è°ƒè¯•ä¿¡æ¯:');
            console.log('loadingText:', loadingText);
            
            // æ›´æ–°åŠ è½½è¿›åº¦
            function updateProgress(step, total, message) {
                const percentage = (step / total) * 100;
                console.log(`ğŸ“Š æ›´æ–°è¿›åº¦: ${step}/${total} (${Math.round(percentage)}%) - ${message}`);
                
                // æ›´æ–°ç™¾åˆ†æ¯”æ–‡æœ¬
                const percentageElement = document.getElementById('loading-percentage');
                if (percentageElement) {
                    percentageElement.textContent = Math.round(percentage) + '%'; 
                    console.log('âœ… ç™¾åˆ†æ¯”æ–‡æœ¬å·²æ›´æ–°:', Math.round(percentage) + '%');
                } else {
                    console.error('âŒ loading-percentageå…ƒç´ æœªæ‰¾åˆ°');
                }
                
                if (loadingText) {
                    loadingText.textContent = message;
                    console.log('âœ… æ–‡æœ¬å·²æ›´æ–°:', message);
                } else {
                    console.error('âŒ loadingTextå…ƒç´ æœªæ‰¾åˆ°');
                }
            }
            
            // ç«‹å³æµ‹è¯•è¿›åº¦æ›´æ–°
            updateProgress(0, 11, 'å¼€å§‹åˆå§‹åŒ–...');
            
            try {
                // ç®€åŒ–åˆå§‹åŒ–è¿‡ç¨‹
                updateProgress(1, 11, 'æ­£åœ¨åŠ è½½æ¨¡å—...');
                await new Promise(resolve => setTimeout(resolve, 200));
                
                updateProgress(2, 11, 'æ­£åœ¨åˆå§‹åŒ–æ¸¸æˆç®¡ç†å™¨...');
                console.log('ğŸ“‹ æ­£åœ¨åˆå§‹åŒ– GameManager...');
                try {
                    if (typeof GameManager !== 'undefined') {
                        await GameManager.initialize();
                        console.log('âœ… GameManager åˆå§‹åŒ–å®Œæˆ');
                    } else {
                        console.error('âŒ GameManager æœªå®šä¹‰');
                    }
                } catch (error) {
                    console.error('âŒ GameManager åˆå§‹åŒ–å¤±è´¥:', error);
                }
                await new Promise(resolve => setTimeout(resolve, 200));
                
                updateProgress(3, 11, 'æ­£åœ¨åˆå§‹åŒ–å¯¹è¯ç³»ç»Ÿ...');
                console.log('ğŸ’¬ æ­£åœ¨åˆå§‹åŒ– DialogueSystem...');
                try {
                    if (typeof DialogueSystem !== 'undefined') {
                        await DialogueSystem.initialize();
                        console.log('âœ… DialogueSystem åˆå§‹åŒ–å®Œæˆ');
                    } else {
                        console.error('âŒ DialogueSystem æœªå®šä¹‰');
                    }
                } catch (error) {
                    console.error('âŒ DialogueSystem åˆå§‹åŒ–å¤±è´¥:', error);
                }
                await new Promise(resolve => setTimeout(resolve, 200));
                
                updateProgress(4, 11, 'æ­£åœ¨åˆå§‹åŒ–èƒŒæ™¯ç³»ç»Ÿ...');
                console.log('ğŸ¨ æ­£åœ¨åˆå§‹åŒ– BackgroundSystem...');
                try {
                    if (typeof BackgroundSystem !== 'undefined') {
                        await BackgroundSystem.initialize();
                        console.log('âœ… BackgroundSystem åˆå§‹åŒ–å®Œæˆ');
                    } else {
                        console.error('âŒ BackgroundSystem æœªå®šä¹‰');
                    }
                } catch (error) {
                    console.error('âŒ BackgroundSystem åˆå§‹åŒ–å¤±è´¥:', error);
                }
                await new Promise(resolve => setTimeout(resolve, 200));
                
                updateProgress(5, 11, 'æ­£åœ¨åˆå§‹åŒ–äº”æ„Ÿç³»ç»Ÿ...');
                console.log('ğŸ‘ï¸ æ­£åœ¨åˆå§‹åŒ– SimpleSenseSystem...');
                try {
                    if (typeof SimpleSenseSystem !== 'undefined') {
                        SimpleSenseSystem.initialize();
                        console.log('âœ… SimpleSenseSystem åˆå§‹åŒ–å®Œæˆ');
                    } else {
                        console.error('âŒ SimpleSenseSystem æœªå®šä¹‰');
                    }
                } catch (error) {
                    console.error('âŒ SimpleSenseSystem åˆå§‹åŒ–å¤±è´¥:', error);
                }
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // TextEffectManager å·²åˆ é™¤
                
                updateProgress(6, 11, 'æ­£åœ¨åˆå§‹åŒ–æ™ºèƒ½é¢œè‰²é€‚é…ç³»ç»Ÿ...');
                console.log('ğŸ¨ æ­£åœ¨åˆå§‹åŒ– SmartColorAdapter...');
                try {
                    if (typeof SmartColorAdapter !== 'undefined') {
                        await SmartColorAdapter.initialize();
                        console.log('âœ… SmartColorAdapter åˆå§‹åŒ–å®Œæˆ');
                    } else {
                        console.error('âŒ SmartColorAdapter æœªå®šä¹‰');
                    }
                } catch (error) {
                    console.error('âŒ SmartColorAdapter åˆå§‹åŒ–å¤±è´¥:', error);
                }
                await new Promise(resolve => setTimeout(resolve, 200));
                
                updateProgress(7, 11, 'æ­£åœ¨åˆå§‹åŒ–æ·¡å…¥æ–‡å­—ç³»ç»Ÿ...');
                console.log('âœ¨ æ­£åœ¨åˆå§‹åŒ– FadeTextSystem...');
                try {
                    if (typeof FadeTextSystem !== 'undefined') {
                        await FadeTextSystem.initialize();
                        console.log('âœ… FadeTextSystem åˆå§‹åŒ–å®Œæˆ');
                    } else {
                        console.error('âŒ FadeTextSystem æœªå®šä¹‰');
                    }
                } catch (error) {
                    console.error('âŒ FadeTextSystem åˆå§‹åŒ–å¤±è´¥:', error);
                }
                await new Promise(resolve => setTimeout(resolve, 200));
                
                updateProgress(8, 11, 'æ­£åœ¨å¯åŠ¨æ¸¸æˆ...');
                console.log('ğŸ® æ­£åœ¨å¯åŠ¨æ¸¸æˆ...');
                
                // å»¶è¿Ÿåˆå§‹åŒ–éå…³é”®ç³»ç»Ÿ
                setTimeout(async () => {
                    try {
                        if (typeof ResourceOptimizer !== 'undefined') {
                            await ResourceOptimizer.initialize();
                            console.log('âœ… ResourceOptimizer å»¶è¿Ÿåˆå§‹åŒ–å®Œæˆ');
                        }
                    } catch (error) {
                        console.log('âš ï¸ éå…³é”®ç³»ç»Ÿå»¶è¿Ÿåˆå§‹åŒ–å¤±è´¥:', error);
                    }
                }, 1000);
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // RuntimeDialogues å·²åˆ é™¤ï¼Œç›´æ¥ä½¿ç”¨ EnhancedDeepSkyScript
                
                updateProgress(10, 11, 'æ­£åœ¨åˆå§‹åŒ–å‰§æƒ…ç³»ç»Ÿ...');
                console.log('ğŸ“– æ­£åœ¨åˆå§‹åŒ– StoryManager...');
                try {
                    if (typeof StoryManager !== 'undefined') {
                        await StoryManager.initialize();
                        console.log('âœ… StoryManager åˆå§‹åŒ–å®Œæˆ');
                    } else {
                        console.error('âŒ StoryManager æœªå®šä¹‰');
                    }
                } catch (error) {
                    console.error('âŒ StoryManager åˆå§‹åŒ–å¤±è´¥:', error);
                }
                
                updateProgress(11, 11, 'æ­£åœ¨åˆå§‹åŒ–èƒŒæ™¯éŸ³ä¹...');
                console.log('ğŸµ æ­£åœ¨åˆå§‹åŒ– BGMManager...');
                try {
                    if (typeof BGMManager !== 'undefined') {
                        BGMManager.initialize();
                        console.log('âœ… BGMManager åˆå§‹åŒ–å®Œæˆ');
                    } else {
                        console.error('âŒ BGMManager æœªå®šä¹‰');
                    }
                } catch (error) {
                    console.error('âŒ BGMManager åˆå§‹åŒ–å¤±è´¥:', error);
                }
                
                // åˆå§‹åŒ–äº”æ„Ÿæ˜¾ç¤º
                updateProgress(9, 9, 'æ­£åœ¨åˆå§‹åŒ–äº”æ„Ÿç³»ç»Ÿ...');
                console.log('ğŸ‘ï¸ æ­£åœ¨åˆå§‹åŒ–äº”æ„Ÿæ˜¾ç¤º...');
                try {
                    // åˆå§‹åŒ–æŒç»­æ˜¾ç¤ºäº”æ„Ÿç³»ç»Ÿ
                    if (typeof SimpleSenseSystem !== 'undefined') {
                        SimpleSenseSystem.initialize();
                        console.log('âœ… æŒç»­æ˜¾ç¤ºäº”æ„Ÿç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
                    }
                    
                    if (typeof StoryManager !== 'undefined') {
                        StoryManager.initializeSenses();
                        console.log('âœ… äº”æ„Ÿç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
                    }
                } catch (error) {
                    console.error('âŒ äº”æ„Ÿç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);
                }
                
                // å®Œæˆåˆå§‹åŒ–
                updateProgress(11, 11, 'åˆå§‹åŒ–å®Œæˆï¼Œæ­£åœ¨å¯åŠ¨æ¸¸æˆ...');
                
                // çŸ­æš‚å»¶è¿Ÿåéšè—åŠ è½½å±å¹•
                setTimeout(() => {
                    const loadingScreen = document.getElementById('loading-screen');
                    if (loadingScreen) {
                        loadingScreen.classList.add('hidden');
                        console.log('ğŸ® åŠ è½½å±å¹•å·²éšè—');
                    }
                    
                    // å¼€å§‹èƒŒæ™¯é¢œè‰²è¿‡æ¸¡
                    startBackgroundTransition();
                    
                    // å»¶è¿Ÿå¯åŠ¨æ¸¸æˆï¼Œè®©ç•Œé¢å…ˆæ·¡å…¥
                    setTimeout(() => {
                        console.log('âœ… æ‰€æœ‰ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
                        
                // å¯åŠ¨èƒŒæ™¯éŸ³ä¹
                if (typeof BGMManager !== 'undefined') {
                    BGMManager.startBGM();
                    console.log('ğŸµ èƒŒæ™¯éŸ³ä¹å·²å¯åŠ¨');
                    
                    // åˆå§‹åŒ–BGMæ§åˆ¶ï¼ˆåœ¨éŸ³ä¹å¯åŠ¨åï¼‰
                    initializeBGMControls();
                    
                    // åˆå§‹åŒ–è¯­è¨€åˆ‡æ¢
                    initializeLanguageControls();
                }
                        
                        if (typeof StoryManager !== 'undefined') {
                            // å…ˆæ·¡å…¥äº”æ„Ÿç³»ç»Ÿ
                            fadeInSenses();
                            
                            // å»¶è¿Ÿå¯åŠ¨å¯¹è¯
                            setTimeout(() => {
                                StoryManager.startGame();
                                console.log('ğŸ¯ æ¸¸æˆå·²å¼€å§‹');
                            }, 1000);
                        } else {
                            console.error('âŒ StoryManager æœªæ‰¾åˆ°');
                        }
                    }, 800);
                }, 500);
                
            } catch (error) {
                console.error('âŒ æ¸¸æˆå¯åŠ¨å¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.stack);
                
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.innerHTML = 
                        '<div class="error-content"><h2>å¯åŠ¨å¤±è´¥</h2><p>é”™è¯¯: ' + error.message + '</p><p>è¯·åˆ·æ–°é¡µé¢é‡è¯•</p></div>';
                }
            }
        });
        
        // åˆå§‹åŒ–BGMæ§åˆ¶
        function initializeBGMControls() {
            const bgmToggle = document.getElementById('bgm-toggle');
            const bgmVolumeControl = document.getElementById('bgm-volume-control');
            const bgmVolumeSlider = document.getElementById('bgm-volume-slider');
            const bgmVolumeText = document.getElementById('bgm-volume-text');
            
            if (!bgmToggle || !bgmVolumeControl || !bgmVolumeSlider || !bgmVolumeText) {
                console.warn('BGMæ§åˆ¶å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            // åˆ‡æ¢BGMæ’­æ”¾/æš‚åœ
            bgmToggle.addEventListener('click', () => {
                if (BGMManager.isPlaying) {
                    BGMManager.pauseBGM();
                    bgmToggle.classList.add('muted');
                    bgmToggle.textContent = 'ğŸ”‡';
                } else {
                    BGMManager.resumeBGM();
                    bgmToggle.classList.remove('muted');
                    bgmToggle.textContent = 'ğŸµ';
                }
            });
            
            // éŸ³é‡æ§åˆ¶
            bgmVolumeSlider.addEventListener('input', (e) => {
                const volume = parseInt(e.target.value) / 100;
                BGMManager.setVolume(volume);
                bgmVolumeText.textContent = e.target.value + '%';
            });
            
            // æ˜¾ç¤º/éšè—éŸ³é‡æ§åˆ¶
            bgmToggle.addEventListener('mouseenter', () => {
                bgmVolumeControl.classList.remove('hidden');
            });
            
            bgmVolumeControl.addEventListener('mouseleave', () => {
                bgmVolumeControl.classList.add('hidden');
            });
            
            // åˆå§‹åŒ–çŠ¶æ€ - é»˜è®¤æ˜¾ç¤ºéŸ³ä¹å¼€å¯çŠ¶æ€
            bgmToggle.classList.remove('muted');
            bgmToggle.textContent = 'ğŸµ';
            
            // è®¾ç½®çŠ¶æ€å˜åŒ–å›è°ƒ
            BGMManager.onStateChange = (isPlaying) => {
                if (isPlaying) {
                    bgmToggle.classList.remove('muted');
                    bgmToggle.textContent = 'ğŸµ';
                    console.log('ğŸµ BGMæ§åˆ¶ï¼šéŸ³ä¹å¼€å§‹æ’­æ”¾ï¼Œæ˜¾ç¤ºå¼€å¯çŠ¶æ€');
                } else {
                    bgmToggle.classList.add('muted');
                    bgmToggle.textContent = 'ğŸ”‡';
                    console.log('ğŸµ BGMæ§åˆ¶ï¼šéŸ³ä¹åœæ­¢æ’­æ”¾ï¼Œæ˜¾ç¤ºå…³é—­çŠ¶æ€');
                }
            };
            
            // ç«‹å³æ£€æŸ¥å½“å‰çŠ¶æ€
            if (!BGMManager.isPlaying) {
                bgmToggle.classList.add('muted');
                bgmToggle.textContent = 'ğŸ”‡';
            }
            
            console.log('ğŸµ BGMæ§åˆ¶åˆå§‹åŒ–å®Œæˆ');
        }

        // è¯­è¨€åˆ‡æ¢æ§åˆ¶
        function initializeLanguageControls() {
            const languageToggle = document.getElementById('language-toggle');
            
            if (!languageToggle) {
                console.warn('è¯­è¨€åˆ‡æ¢å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            // è·å–å½“å‰è¯­è¨€è®¾ç½®ï¼ˆé»˜è®¤ä¸­æ–‡ï¼‰
            let currentLanguage = localStorage.getItem('gameLanguage') || 'zh';
            
            // è®¾ç½®åˆå§‹çŠ¶æ€
            updateLanguageButton(currentLanguage);
            
            // åˆ‡æ¢è¯­è¨€
            languageToggle.addEventListener('click', () => {
                currentLanguage = currentLanguage === 'zh' ? 'en' : 'zh';
                localStorage.setItem('gameLanguage', currentLanguage);
                updateLanguageButton(currentLanguage);
                switchLanguage(currentLanguage);
                console.log(`ğŸŒ è¯­è¨€å·²åˆ‡æ¢åˆ°: ${currentLanguage === 'zh' ? 'ä¸­æ–‡' : 'English'}`);
            });
            
            console.log('ğŸŒ è¯­è¨€åˆ‡æ¢æ§åˆ¶åˆå§‹åŒ–å®Œæˆ');
        }
        
        // æ›´æ–°è¯­è¨€æŒ‰é’®çŠ¶æ€
        function updateLanguageButton(language) {
            const languageToggle = document.getElementById('language-toggle');
            if (language === 'en') {
                languageToggle.classList.add('english');
                languageToggle.textContent = 'ğŸ‡ºğŸ‡¸';
                languageToggle.title = 'Switch to Chinese';
            } else {
                languageToggle.classList.remove('english');
                languageToggle.textContent = 'ğŸŒ';
                languageToggle.title = 'Switch to English';
            }
        }
        
        // åˆ‡æ¢è¯­è¨€
        function switchLanguage(language) {
            if (language === 'en') {
                // åˆ‡æ¢åˆ°è‹±æ–‡
                if (typeof EnhancedDeepSkyScript_EN !== 'undefined') {
                    // æ›¿æ¢StoryManagerä¸­çš„è„šæœ¬å¼•ç”¨
                    window.EnhancedDeepSkyScript = EnhancedDeepSkyScript_EN;
                    console.log('ğŸŒ å·²åˆ‡æ¢åˆ°è‹±æ–‡è„šæœ¬');
                } else {
                    console.warn('è‹±æ–‡è„šæœ¬æœªåŠ è½½');
                }
            } else {
                // åˆ‡æ¢åˆ°ä¸­æ–‡
                if (typeof window.OriginalEnhancedDeepSkyScript !== 'undefined') {
                    window.EnhancedDeepSkyScript = window.OriginalEnhancedDeepSkyScript;
                } else {
                    // é‡æ–°åŠ è½½ä¸­æ–‡è„šæœ¬
                    location.reload();
                }
                console.log('ğŸŒ å·²åˆ‡æ¢åˆ°ä¸­æ–‡è„šæœ¬');
            }
        }
        
        // ä¿å­˜åŸå§‹ä¸­æ–‡è„šæœ¬å¼•ç”¨
        window.addEventListener('load', () => {
            if (typeof EnhancedDeepSkyScript !== 'undefined') {
                window.OriginalEnhancedDeepSkyScript = EnhancedDeepSkyScript;
            }
        });
    </script>
</body>
</html>